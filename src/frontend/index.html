<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <title>Internet Of Things - Wit.Ai</title>
</head>

<body>
    <div class="dashboard">
        <header>
            <div class="f fe">
                <div class="icon icon-w"></div>
                <div class="heading">
                    <h5 class="date" id="last-update-day">null</h5>
                    <h3 class="title">Cloudy <button class="btn" id="refresh"><i class="fas fa-sync"></i></button></h3>
                </div>
            </div>

            <div class="weather f">
                <div>
                    <strong id="lblTemp">null</strong>
                    <p>Indoor Temp.</p>
                </div>
                <div>
                    <strong id="lblHum">null</strong>
                    <p>Indoor Humidity</p>
                </div>
                <div>
                    <i class="far fa-clock"></i><strong id="last-update-time"> 11:53:43</strong>
                    <p>Last Update</p>
                </div>
            </div>
        </header>
        <section>
            <div class="m-speech">
                <h2>Speech Recognition</h2>
                <i class="fas fa-microphone" id="mic"></i>
                <p hidden class="js-api-support">API not supported</p>
                <textarea class="form-control" placeholder="Transcription" style="resize: none"
                    aria-label="Transcription" id="text" class="log" readonly></textarea>
                <div class="js-api-info">
                    <h2>Log</h2>
                    <div id="log" class="log"></div>
                </div>
            </div>
            <div class="m-table-suhu">
                <h2>Tabel Suhu</h2>
                <table id="sensor-table" class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Humidity</th>
                            <th>Temperature</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <!-- Category -->
            <div class="category">
                <ul>
                    <li><a href="#!" class="active">Living Room</a></li>
                    <li><a href="#!">Kitchen</a></li>
                    <li><a href="#!">Dinning</a></li>
                    <li><a href="#!">Weather</a></li>
                </ul>
            </div>
            <!-- Appliances -->
            <div class="appliances">

                <div class="appliance">
                    <input type="checkbox" name="a" id="a">
                    <label for="a">
                        <i class="l"></i>
                        <strong>Lampu</strong>
                        <span id="status-lampu"></span>
                        <small></small>
                    </label>
                </div>

                <div class="appliance" id="pompa">
                    <input type="checkbox" name="a" id="b">
                    <label for="b">
                        <i class="r"></i>
                        <strong>Pompa Air</strong>
                        <span id="status-pompa"></span>
                        <small></small>
                    </label>
                </div>

                <div class="appliance">
                    <input type="checkbox" name="a" id="c">
                    <label for="c">
                        <i class="a"></i>
                        <strong>AC</strong>
                        <span id="status-ac"></span>
                        <small></small>
                    </label>
                </div>

                <div class="appliance">
                    <input type="checkbox" name="a" id="d">
                    <label for="d">
                        <i class="f"></i>
                        <strong>Kulkas</strong>
                        <span id="status-kulkas"></span>
                        <small></small>
                    </label>
                </div>
            </div>
        </section>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript">
    </script>
    <script>
        let device;
        const apiHost = "http://103.146.203.97:8989"; // host your api gateway i.e http://localhost:3000
        var mqtt;
        const mqttHost = "103.146.203.97"; // your mqtt host i.e. localhost
        const mqttPort = 9001; // port mqqt (websocket) default = 9001
        const dateLang = "id-ID" // dateLocale Format
        const speechRecognitionLang = "ID" // language used in speechRecognition i.e "EN"
        // Get Data Suhu
        const refresh = document.getElementById("refresh");
        refresh.addEventListener("click", function () {
            getData("pompa");
        });

        // Home Appliance
        const checkLampu = document.getElementById("a");
        const checkPompa = document.getElementById("b");
        let textLampu = document.getElementById("status-lampu");
        let textPompa = document.getElementById("status-pompa");
        checkLampu.checked = false;
        checkPompa.checked = false;
        textLampu.setAttribute("data-o", "nyala");
        textPompa.setAttribute("data-o", "nyala");
        checkLampu.addEventListener("change", function () {
            device = "lampu"
            if (checkLampu.checked == true) {
                console.log(`${device} nyala`);
                deviceIsOn(device, true, "Nyala");
            } else {
                console.log(`${device} mati`);
                deviceIsOn(device, false, "Mati");
            }
        });
        checkPompa.addEventListener("change", function () {
            device = "pompa"
            if (checkPompa.checked == true) {
                console.log(`${device} nyala`);
                deviceIsOn(device, true, "Nyala");
            } else {
                console.log(`${device} mati`);
                deviceIsOn(device, false, "Mati");
            }
        });

        function mqttConnect() {
            mqtt = new Paho.MQTT.Client(mqttHost, Number(mqttPort), "client-web");
            mqtt.connect({
                onSuccess: onConnect
            });
            mqtt.onConnectionLost = onConnectionLost;
            mqtt.onMessageArrived = onMessageArrived;
        }

        function onConnect() {
            // Once a connection has been made, make a subscription and send a message.
            mqtt.subscribe("web");
        }

        function onMessageArrived(message) {
            const payload = JSON.parse(message.payloadString);
            _lastUpdate(false, payload);
            var tablerow = tableref.insertRow(0)
            tablerow.className = 'fade-in'
            tablerow.innerHTML =
                `<tr class=fade-in> <td>${new Date(payload.date).toLocaleString(dateLang)}</td> <td>${payload.humidity} %</td> <td>${payload.temp} 째 C</td> </tr>`
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("onConnectionLost:" + responseObject.errorMessage);
            }
        }

        function send(msg) {
            const raw = JSON.stringify({
                "message": msg
            });
            fetch(apiHost + "/send", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: raw,
                    redirect: 'follow'
                })
                .then(response => response.text())
                .then(result => console.log(result))
                .catch(error => console.log('error', error));
        }

        function deviceIsOn(device, status, deviceStats) {
            const raw = JSON.stringify({
                "message": status ? `nyalakan ${device}` : `matikan ${device}`
            });
            fetch(apiHost + "/send", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: raw,
                    redirect: 'follow'
                })
                .then(response => response.text())
                .then(result => console.log(result))
                .catch(error => console.log('error', error));

            document.getElementById(`status-${device}`).setAttribute('data-o', deviceStats);
        }

        function getData(device) {
            const raw = JSON.stringify({
                "message": `ambil data ${device}`
            });
            fetch(apiHost + "/send", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: raw,
                    redirect: 'follow'
                })
                .then(response => response.text())
                .then(result => console.log(result))
                .catch(error => console.log('error', error));
        }

        function logEvent(string) {
            var log = document.getElementById('log');

            log.innerHTML = string + '<br />' + log.innerHTML;
        }

        var tableref = document.getElementById('sensor-table').getElementsByTagName('tbody')[0];
        document.addEventListener("DOMContentLoaded", function (event) {
            fetch(apiHost + "/sensor-data")
                .then(response => response.json())
                .then(result => {
                    _lastUpdate(true, result[0]);
                    result.forEach(res => {
                        tableref.insertRow(tableref.rows.length).innerHTML =
                            `<tr> <td>${new Date(res.date).toLocaleString(dateLang)}</td> <td>${res.payload.hum} %</td> <td>${res.payload.temp}째 C</td> </tr>`
                    })
                });

            mqttConnect()
        });

        window.onload = () => {
            window.SpeechRecognition = window.SpeechRecognition ||
                window.webkitSpeechRecognition ||
                null;

            if (!SpeechRecognition) {
                document.querySelector('.js-api-support').removeAttribute('hidden');
                document.querySelector('.js-api-info').setAttribute('hidden', '');
                [].forEach.call(document.querySelectorAll('form button'), function (button) {
                    button.setAttribute('disabled', '');
                });
            } else {
                var recognizer = new SpeechRecognition();
                var transcription = document.getElementById('text');

                // Start recognising
                recognizer.addEventListener('result', function (event) {
                    transcription.textContent = '';

                    for (var i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            document.getElementById('mic').classList.toggle('fa-microphone-slash');
                            document.getElementById('mic').classList.toggle('fa-microphone');
                            send(event.results[i][0].transcript)
                            transcription.textContent = event.results[i][0].transcript +
                                ' (Confidence: ' + event.results[i][0].confidence + ')';
                        } else {
                            transcription.textContent += event.results[i][0].transcript;
                        }
                    }
                });

                // Listen for errors
                recognizer.addEventListener('error', function (event) {
                    logEvent('Recognition error: ' + event.message);
                });

                recognizer.addEventListener('end', function () {
                    logEvent('Recognition ended');
                });

                document.getElementById('mic').addEventListener('click', function (e) {
                    document.getElementById('log').textContent = '';

                    transcription.textContent = '';

                    recognizer.lang = speechRecognitionLang
                    recognizer.continuous = !true;
                    recognizer.interimResults = true;

                    try {
                        recognizer.start();
                        e.target.classList.toggle('fa-microphone');
                        e.target.classList.toggle('fa-microphone-slash');
                        logEvent('Recognition started');
                    } catch (ex) {
                        logEvent('Recognition error: ' + ex.message);
                    }
                });
            }
        }

        function _lastUpdate(statusLoaded, result) {
            if (statusLoaded) {
                let lastUpdateTime = _timeUpdate(new Date(result.date));
                let lastUpdateDay = _dayUpdate(new Date(result.date));
                document.getElementById('lblTemp').innerHTML = `${result.payload.temp}째 C`;
                document.getElementById('lblHum').innerHTML = `${result.payload.hum}%`;
                document.getElementById('last-update-time').innerHTML = ` ${lastUpdateTime}`;
                document.getElementById('last-update-day').innerHTML = ` ${lastUpdateDay}`;
            } else {
                let lastUpdateTime = _timeUpdate(new Date(result.date));
                let lastUpdateDay = _dayUpdate(new Date(result.date));
                document.getElementById('lblTemp').innerHTML = `${result.temp}째 C`;
                document.getElementById('lblHum').innerHTML = `${result.humidity}%`;
                document.getElementById('last-update-time').innerHTML = ` ${lastUpdateTime}`;
                document.getElementById('last-update-day').innerHTML = ` ${lastUpdateDay}`;
            }
        }

        function _timeUpdate(time) {
            let h, m, s;
            h = time.getHours();
            m = time.getMinutes();
            s = time.getSeconds();
            return ` ${h}:${m}:${s}`;
        }

        function _dayUpdate(date) {
            let hari, tanggal, bulan, tahun;
            let arrbulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September",
                "Oktober", "November", "Desember"
            ];
            let myDays = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jum&#39;at', 'Sabtu'];
            hari = date.getDay();
            tanggal = date.getDate();
            bulan = date.getMonth();
            tahun = date.getFullYear();
            return myDays[hari] + ", " + tanggal + " " + arrbulan[bulan] + " " + tahun;
        }
    </script>
</body>

</html>